sap.ui.define(["zjblessons/Worklist/controller/BaseController","sap/ui/model/json/JSONModel","zjblessons/Worklist/model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/Fragment","sap/m/TextArea"],function(e,t,s,i,r,o){"use strict";return e.extend("zjblessons.Worklist.controller.Worklist",{formatter:s,onInit:function(){var e,s,i=this.byId("table");s=i.getBusyIndicatorDelay();this._aTableSearchState=[];e=new t({worklistTableTitle:this.getResourceBundle().getText("worklistTableTitle"),shareOnJamTitle:this.getResourceBundle().getText("worklistTitle"),shareSendEmailSubject:this.getResourceBundle().getText("shareSendEmailWorklistSubject"),shareSendEmailMessage:this.getResourceBundle().getText("shareSendEmailWorklistMessage",[location.href]),tableNoDataText:this.getResourceBundle().getText("tableNoDataText"),tableBusyDelay:0,validateError:false,dialogParams:{height:"400px",width:"250px"},textAreaHeight:"130px",Messages:[]});this.setModel(e,"worklistView");this.getRouter().getRoute("worklist").attachPatternMatched(this._onObjectMatched,this);i.attachEventOnce("updateFinished",function(){e.setProperty("/tableBusyDelay",s)});this.oLink=new sap.m.Link({text:this.getResourceBundle().getText("ttlShowMoreInfo"),href:"http://sap.com",target:"_blank"});this.oMessageTemplate=new sap.m.MessageItem({type:"{worklistView>type}",title:"{worklistView>title}",activeTitle:"{worklistView>active}",description:"{worklistView>description}",subtitle:"{worklistView>subtitle}",counter:"{worklistView>counter}",link:this.oLink});this.oMessagePopover=new sap.m.MessagePopover({items:{model:"worklistView",path:"worklistView>/Messages",template:this.oMessageTemplate}});this.byId("messagePopoverBtn").addDependent(this.oMessagePopover)},onUpdateFinished:function(e){var t,s=e.getSource(),i=e.getParameter("total");if(i&&s.getBinding("items").isLengthFinal()){t=this.getResourceBundle().getText("worklistTableTitleCount",[i])}else{t=this.getResourceBundle().getText("worklistTableTitle")}this.getModel("worklistView").setProperty("/worklistTableTitle",t)},onPress:function(e){this._showObject(e)},_onObjectMatched:function(){this.getModel().resetChanges()},_loadCreateMateriaFragment:function(e){if(!this.oCreateDialog){this.pCreateMaterial=o.load({name:"zjblessons.Worklist.view.fragment.CreateMaterial",controller:this,id:"fCreateDialog"}).then(e=>{this.oCreateDialog=e;this.getView().addDependent(this.oCreateDialog);return Promise.resolve(e)})}this.pCreateMaterial.then(t=>{t.setBindingContext(e);t.data("errors",[]);t.open()})},onPressCreateMaterial:function(){const e={Language:"RU",Version:"A",MaterialID:"0"};const t=this.getModel().createEntry("/zjblessons_base_Materials",{properties:e});this._loadCreateMateriaFragment(t)},oClearDialog:function(e){const t=e.getSource().getControlsByFieldGroupId();t.forEach(e=>{if(e.mProperties.fieldGroupIds[0]){e.setValue("");e.setValueState("None");e.setValueStateText("")}})},onPressCloseCreateDialog:function(e){e.getSource().getParent().getParent().close()},onPressSaveCreateMaterial:function(){this._validateSaveMaterial(this.oCreateDialog);if(!this.getModel("worklistView").getProperty("/validateError")){this.getModel().submitChanges({success:e=>{this.addMessageCreated(e)},error:e=>{this.addMessageErrorCreated(e)}});this.oCreateDialog.close()}},addInfoMessage:function(e){const t=e.getSource().mAggregations.cells?e.getSource().mAggregations.cells[0].mProperties.text:e.getSource().getParent().getParent().getTitle();const s=this.getModel("worklistView").getProperty("/Messages").slice();s.push({type:sap.ui.core.MessageType.Information,title:this.getResourceBundle().getText("ttlViewed"),description:`${this.getResourceBundle().getText("descMaterialTextMessPopover")} ${t}`,subtitle:`${t} ${this.getResourceBundle().getText("msgViewed")}`,counter:1,link:this.oLink});this.getModel("worklistView").setProperty("/Messages",s)},addMessageCreated:function(e){const t=e.__batchResponses[0].__changeResponses[0].data;const s=this.getModel("worklistView").getProperty("/Messages").slice();s.push({type:sap.ui.core.MessageType.Success,title:this.getResourceBundle().getText("ttlCreated"),description:`${this.getResourceBundle().getText("descMaterialTextMessPopover")} ${t.MaterialText}`,subtitle:`${t.MaterialText} ${this.getResourceBundle().getText("msgCreated")}`,counter:1,link:this.oLink});this.getModel("worklistView").setProperty("/Messages",s)},addMessageErrorCreated:function(e){const t=this.getModel("worklistView").getProperty("/Messages").slice();t.push({type:sap.ui.core.MessageType.Error,title:this.getResourceBundle().getText("ttlNotCreated"),description:`${this.getResourceBundle().getText("ttlError")} ${e.message}`,subtitle:`${this.oDeletedMaterial.MaterialText} ${this.getResourceBundle().getText("msgNotCreated")}`,counter:1,link:this.oLink});this.getModel("worklistView").setProperty("/Messages",t)},_validateSaveMaterial:function(e){const t=e.getContent()[0].getControlsByFieldGroupId();t.forEach(e=>{if(e.mProperties.fieldGroupIds[0]){e.fireValidateFieldGroup()}})},onPressDeleteEntry:function(e){this.sEntryPath=e.getSource().getBindingContext().getPath();this.oDeletedMaterial=e.getSource().getBindingContext().getObject();sap.m.MessageBox.confirm(this.getResourceBundle().getText("msgdeletionConfiramtion"),{actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],emphasizedAction:sap.m.MessageBox.Action.OK,initialFocus:null,onClose:function(e){if(e==="OK"){this.getModel().remove(this.sEntryPath,{success:()=>{this.addMessageDeleted()},error:e=>{this.addMessageErrorDeleted(e)}})}}.bind(this)})},addMessageDeleted:function(){const e=this.getModel("worklistView").getProperty("/Messages").slice();e.push({type:sap.ui.core.MessageType.Warning,title:this.getResourceBundle().getText("ttlDeleted"),description:`${this.getResourceBundle().getText("descMaterialTextMessPopover")} ${this.oDeletedMaterial.MaterialText}`,subtitle:`${this.oDeletedMaterial.MaterialText} ${this.getResourceBundle().getText("msgDeleted")}`,counter:1,link:this.oLink});this.getModel("worklistView").setProperty("/Messages",e)},addMessageErrorDeleted:function(e){const t=this.getModel("worklistView").getProperty("/Messages").slice();t.push({type:sap.ui.core.MessageType.Error,title:this.getResourceBundle().getText("ttlNotDeleted"),description:`${this.getResourceBundle().getText("ttlError")} ${e.message}`,subtitle:`${this.oDeletedMaterial.MaterialText} ${this.getResourceBundle().getText("msgNotDeleted")}`,counter:1,link:this.oLink});this.getModel("worklistView").setProperty("/Messages",t)},onNavBack:function(){history.go(-1)},onSearchMaterialText:function(e){const t=e.getParameter("query")||e.getParameter("newValue");this.byId("table").getBinding("items").filter(this.getFilters(t))},getFilters:function(e){const t=[];if(e){t.push(new i({filters:[new i("MaterialText",r.Contains,e),new i("MaterialDescription",r.Contains,e),new i({filters:[new i("CreatedByFullName",r.Contains,e),new i("ModifiedByFullName",r.Contains,e)],and:true})],and:false}))}return t},onRefresh:function(){var e=this.byId("table");e.getBinding("items").refresh()},_showObject:function(e){this.addInfoMessage(e);this.getRouter().navTo("object",{objectId:e.getSource().getBindingContext().getProperty("MaterialID")})},_applySearch:function(e){var t=this.byId("table"),s=this.getModel("worklistView");t.getBinding("items").filter(e,"Application");if(e.length!==0){s.setProperty("/tableNoDataText",this.getResourceBundle().getText("worklistNoDataWithSearchText"))}},validateFieldGroupMaterial:function(e){const t=e.getSource();const s=this.oCreateDialog.data("errors");let i=true;let r;switch(t.getProperty("fieldGroupIds")[0]){case"input":i=!!t.getValue();r=this.getResourceBundle().getText("ttlInputError");break;case"select":i=!!t.getSelectedItem();r=r=this.getResourceBundle().getText("ttlSelectError");break;case"inputRating":const e=/^[0-9]\.\d{1,2}$/;if(t.getValue()){i=e.test(t.getValue());r=r=this.getResourceBundle().getText("ttlInputRatingError")}else{i=!!t.getValue();r=this.getResourceBundle().getText("ttlInputError")}break}t.setValueState(i?"None":"Error");t.setValueStateText(r);if(i){if(s.indexOf(t)===-1)return;s.splice(s.indexOf(t),1)}else{if(s.indexOf(t)===-1){s.push(t)}}this.getModel("worklistView").setProperty("/validateError",!!s.length)},onBeforeCloseDialog:function(e){const t=e.getSource()._oManuallySetSize;if(t){this.getModel("worklistView").setProperty("/dialogParams/height",t.height+"px");this.getModel("worklistView").setProperty("/dialogParams/width",t.width+"px")}else{e.getSource().destroy();this.oCreateDialog=null}sap.ui.core.ResizeHandler.deregister(e.getSource());this.getModel().resetChanges();this.oClearDialog(e)},onPressMaterialTextDropInfo:function(e){const t=e.getSource();if(!this.oMaterialPopover){this.oMaterialPopover=o.load({name:"zjblessons.Worklist.view.fragment.Popover",id:this.getView().getId(),controller:this}).then(e=>{this.getView().addDependent(e);return Promise.resolve(e)})}this.oMaterialPopover.then(e=>{e.setBindingContext(t.getBindingContext());e.openBy(t)})},onPressCloseMaterialPopover:function(e){e.getSource().getParent().getParent().close()},onPressGoToMaterial:function(e){this._showObject(e)},onPressOpenActionSheet:function(e){const t=e.getSource();if(!this._pActionSheet){this._pActionSheet=o.load({id:this.getView().getId(),controller:this,name:"zjblessons.Worklist.view.fragment.ActionSheet"}).then(e=>{this.getView().addDependent(e);return Promise.resolve(e)})}this._pActionSheet.then(e=>{e.openBy(t)})},onAfterOpenDialog:function(e){const t=e.getSource();sap.ui.core.ResizeHandler.register(t,()=>{const e=t.getFooter().getDomRef().getBoundingClientRect().top,s=t.getContent()[0].mAggregations.items,i=s[s.length-1].getDomRef().getBoundingClientRect().top;this.getModel("worklistView").setProperty("/textAreaHeight",e-i-20+"px")})},onPressMessagePopover:function(e){this.oMessagePopover.toggle(e.getSource())},onPressOpenSelectDialog:function(){if(!this._pSelectDialog){this._pSelectDialog=o.load({controller:this,id:this.getView().getId(),name:"zjblessons.Worklist.view.fragment.SelectDialog"}).then(e=>{this.getView().addDependent(e);return Promise.resolve(e)})}this._pSelectDialog.then(e=>{e.getBinding("items").filter([]);e.open()})},onSearchSelectDialog:function(e){const t=e.getParameter("value");e.getParameter("itemsBinding").filter(this.getFilters(t))},onPressRegistration:function(){return new Promise((e,t)=>{if(!this._pRegistrationFragment){this._pRegistrationFragment=o.load({name:"zjblessons.Worklist.view.fragment.Registration",controller:this,id:this.getView().getId()}).then(e=>{this.getView().addDependent(e);return e})}this._pRegistrationFragment.then(t=>{t.data("errors",[]);e(t.open())}).catch(e=>{sap.m.MessageBox.error(e.toString());t()})})},validateFieldGroupRegistration:function(e){const t=e.getSource();const s=t.getParent().getParent();this.aErrors=s.data("errors")||[];let i=true;switch(t.getProperty("fieldGroupIds")[0]){case"input":i=!!t.getValue();break;case"timePicker":i=!!t.getValue()&&t._isValidValue();break;case"datePicker":i=!!t.getValue()&&t.isValidValue();break;case"inputEmail":try{i=this.validateEmail(t.getValue())}catch(e){i=false;this.craeteMessageErrorStrip(t,e)}finally{break}}try{if(i){if(this.aErrors.indexOf(t)===-1)return;this.aErrors.splice(this.aErrors.indexOf(t),1)}else{if(this.aErrors.indexOf(t)===-1){this.aErrors.push(t)}}t.setValueState(i?"None":"Error")}catch(e){switch(s.getId().replace("Worklist---worklist--","")){case"registrationDialog":this.craeteMessageErrorStrip(t,e);break;case"dateTimeDialog":sap.m.MessageToast.show(e.toString());break;default:sap.m.MessageToast.show(e.toString());break}}finally{this.saveBtnSearch(t)}},saveBtnSearch:function(e){if(!!e.mAggregations.footer){e.getFooter().mAggregations.content[2].setEnabled(!this.aErrors.length)}else{this.saveBtnSearch(e.getParent())}},craeteMessageErrorStrip:function(e,t){if(!this.oMsgStrip)this.oMsgStrip=new sap.m.MessageStrip({text:`${t}`,showCloseButton:true,showIcon:false,type:sap.ui.core.MessageType.Error,close:()=>{this.oMsgStrip=null}});e.getParent().getParent().addContent(this.oMsgStrip)},onpRressRegistrationSave:function(e){this._validateRegistration(e.getSource().getParent().getParent())},_validateRegistration:function(e){const t=e.getContent()[0].getControlsByFieldGroupId();t.forEach(e=>{if(e.mProperties.fieldGroupIds[0]){e.fireValidateFieldGroup()}})},beforeCloseHandler:function(e){if(this.oMsgStrip){this.oMsgStrip.close();this.oMsgStrip=null}this.getModel().resetChanges();e.getSource().getFooter().mAggregations.content[2].setEnabled(true);this.oClearDialog(e)},onPressTimeDate:function(){return new Promise((e,t)=>{if(!this._pDateTimeFragment){this._pDateTimeFragment=o.load({name:"zjblessons.Worklist.view.fragment.DateTime",controller:this,id:this.getView().getId()}).then(e=>{this.getView().addDependent(e);return e})}this._pDateTimeFragment.then(t=>{t.data("errors",[]);e(t.open())}).catch(e=>{sap.m.MessageBox.error(e.toString());t()})})},onPressLogin:function(){return new Promise((e,t)=>{if(!this._pLoginFragment){this._pLoginFragment=o.load({name:"zjblessons.Worklist.view.fragment.Login",controller:this,id:this.getView().getId()}).then(e=>{this.getView().addDependent(e);return e})}this._pLoginFragment.then(t=>{t.data("errors",[]);e(t.open())}).catch(e=>{sap.m.MessageBox.error(e.toString());t()})})},validateEmail:function(e){const t=/^\w+[\w-+\.]*\@\w+([-\.]\w+)*\.[a-zA-Z]{2,}$/;if(!t.test(e)){throw new Error(this.getResourceBundle().getText("msgValidateMailError"))}return t.test(e)},onPressList:function(){this._showList()},_showList:function(){this.getRouter().navTo("list")}})});
//# sourceMappingURL=Worklist.controller.js.map