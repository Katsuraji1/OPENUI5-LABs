sap.ui.define(["zjblessons/Worklist/controller/BaseController","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","zjblessons/Worklist/model/formatter","sap/ui/core/Fragment","sap/ui/core/Item","sap/m/MessageBox"],function(e,t,i,s,o,r,n){"use strict";return e.extend("zjblessons.Worklist.controller.Object",{formatter:s,onInit:function(){var e,i=new t({busy:true,delay:0,editMode:false,selectedKeyITB:"list",validateError:false});this.getRouter().getRoute("object").attachPatternMatched(this._onObjectMatched,this);e=this.getView().setBusyIndicatorDelay(0).getBusyIndicatorDelay();this.setModel(i,"objectView");this.getOwnerComponent().getModel().metadataLoaded().then(function(){i.setProperty("/delay",e)});this.fListEdit=this.byId("listTab").data("aValidateErrors",[])},onNavBack:function(){const e=i.getInstance().getPreviousHash();if(e!==undefined){history.go(-1)}else{this.getRouter().navTo("worklist",{},true)}this.onPressCancelEditMaterial()},onChange:function(e){const t=e.getParameter("state");!t&&this._validateSaveMaterial();if(!t&&this.getModel().hasPendingChanges()||this.getModel("objectView").getProperty("/validateError")){sap.m.MessageBox.confirm(this.getResourceBundle().getText("ttlSaveChanges"),{title:this.getResourceBundle().getText("ttlChooseAction"),actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL,sap.m.MessageBox.Action.CLOSE],emphasizedAction:sap.m.MessageBox.Action.OK,textDirection:sap.ui.core.TextDirection.Inherit,initialFocus:null,onClose:e=>{if(e==="OK"){this.onPressSaveEditMaterial()}else if(e==="CANCEL"){this.onPressCancelEditMaterial()}}});this._setEditMode(true)}else{this._setEditMode(t)}},onPressEditMaterial:function(){this._setEditMode(true)},onPressCancelEditMaterial:function(){this._clearValidateErrors();this.getModel("objectView").setProperty("/validateError",false);this.getModel().resetChanges();this._setEditMode(false)},onPressSaveEditMaterial:function(){this._validateSaveMaterial();if(!this.getModel("objectView").getProperty("/validateError")){if(this.getModel().hasPendingChanges()){this.getModel().submitChanges({success:function(){sap.m.MessageToast.show(this.getResourceBundle().getText("msgSuccessfullyChanged"),{duration:1e3,animationTimingFunction:"ease",animationDuration:1e3})}.bind(this),error:function(e){sap.m.MessageToast.show(this.getResourceBundle().getText("msgError"),{duration:1e3,animationTimingFunction:"ease",animationDuration:1e3})}.bind(this)})}this._setEditMode(false)}},_onObjectMatched:function(e){this._setEditMode(false);const t=e.getParameter("arguments").objectId;this.getModel().metadataLoaded().then(function(){const e=this.getModel().createKey("zjblessons_base_Materials",{MaterialID:t});this._bindView("/"+e)}.bind(this))},_bindView:function(e){var t=this.getModel("objectView"),i=this.getModel();this.getView().bindElement({path:e,events:{change:this._onBindingChange.bind(this),dataRequested:function(){i.metadataLoaded().then(function(){t.setProperty("/busy",true)})},dataReceived:function(){t.setProperty("/busy",false)}}})},_onBindingChange:function(){var e=this.getView(),t=this.getModel("objectView"),i=e.getElementBinding();if(!i.getBoundContext()){this.getRouter().getTargets().display("objectNotFound");return}var s=this.getResourceBundle(),o=e.getBindingContext().getObject(),r=o.MaterialID,n=o.CreatedBy;t.setProperty("/busy",false)},_setEditMode:function(e){this.getModel("objectView").setProperty("/editMode",e);const t=this.getModel("objectView").getProperty("/selectedKeyITB");if(e&&t==="list"){this._bindSelectGroup();this._bindSubSelectGroup()}if(t==="form"){this._addFormContent(e?"Edit":"View")}},onSelectIconTabBar:function(e){const t=e.getSource().getSelectedKey();this.getModel("objectView").setProperty("/selectedKeyITB",t);if(t!=="form")return;this._addFormContent("View")},_bindSelectGroup:function(){this.byId("SelectGroup").bindItems({path:"/zjblessons_base_Groups",template:new sap.ui.core.Item({key:"{GroupID}",text:"{GroupText}"}),sorter:new sap.ui.model.Sorter("GroupText",true),filters:new sap.ui.model.Filter("GroupText",sap.ui.model.FilterOperator.NE,null)})},_bindSubSelectGroup:function(){this._getSubGroupSelectTemplate().then(e=>{this.byId("SelectSubGroup").bindItems({path:"/zjblessons_base_SubGroups",template:e,sorter:new sap.ui.model.Sorter("SubGroupText",true)})})},_addFormContent(e){if(!this[`pForm${e}`]){this[`pForm${e}`]=o.load({name:"zjblessons.Worklist.view.fragment.Form"+e,controller:this,id:this.getView().getId()}).then(e=>{this.fFormEditView=e;this.getView().addDependent(this.fFormEditView);return Promise.resolve(e)})}this[`pForm${e}`].then(e=>{const t=this.byId("FormIconTabFilter");this.fFormEditView.data("aValidateErrors",[]);t.removeAllContent();t.insertContent(e,0)})},_getSubGroupSelectTemplate:function(){return new Promise((e,t)=>{if(!this.pSubGroupSelectTemplate){this.pSubGroupSelectTemplate=o.load({name:"zjblessons.Worklist.view.fragment.SubGroupSelectTemplate",controller:this,id:this.getView().getId()}).then(e=>e)}this.pSubGroupSelectTemplate.then(t=>{e(t)}).catch(e=>{n.error(e.toString());t()})})},validateFieldGroupMaterial:function(e){const t=e.getSource();const i=this.getModel("objectView").getProperty("/selectedKeyITB");const s=i==="list"?this.fListEdit.data("aValidateErrors"):this.fFormEditView.data("aValidateErrors");let o=true;let r;switch(t.getProperty("fieldGroupIds")[0]){case i==="list"?"listInput":"formInput":o=!!t.getValue();r=this.getResourceBundle().getText("ttlInputError");break;case i==="list"?"listSelect":"formSelect":o=!!t.getSelectedItem();r=r=this.getResourceBundle().getText("ttlSelectError");break;case i==="list"?"listInputRating":"formInputRating":const e=/^[0-9]\.\d{1,2}$/;if(t.getValue()){o=e.test(t.getValue());r=r=this.getResourceBundle().getText("ttlInputRatingError")}else{o=!!t.getValue();r=this.getResourceBundle().getText("ttlInputError")}break}t.setValueState(o?"None":"Error");t.setValueStateText(r);if(o){if(s.indexOf(t)===-1)return;s.splice(s.indexOf(t),1)}else{if(s.indexOf(t)===-1){s.push(t)}}this.getModel("objectView").setProperty("/validateError",!!s.length)},_clearValidateErrors:function(){const e=this.getView().getControlsByFieldGroupId();e.forEach(e=>{if(e.mProperties.fieldGroupIds[0]){e.setValueState("None");e.setValueStateText("")}})},_validateSaveMaterial:function(){const e=this.getView().getControlsByFieldGroupId();e.forEach(e=>{if(e.mProperties.fieldGroupIds[0]){e.fireValidateFieldGroup()}})}})});
//# sourceMappingURL=Object.controller.js.map